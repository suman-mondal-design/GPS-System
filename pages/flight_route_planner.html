<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flight Route Planner - AirRoute Navigator</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fairrouten4720back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
</head>
<body class="bg-background font-inter">
    <!-- Header Navigation -->
    <header class="bg-white shadow-aviation-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-text-primary">Mahadev Navigator</h1>
                        <p class="text-xs text-text-secondary">Flight Route Planner</p>
                    </div>
                </div>

<!-- Navigation Menu -->
<nav class="hidden md:flex items-center space-x-8">
    <a href="flight_route_planner.html" class="text-primary font-medium border-b-2 border-primary pb-1">
        Route Planner
    </a>
    <!-- <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2 text-text-secondary">
            <i class="fas fa-clock text-sm"></i>
            <div class="flex flex-col items-end">
                <span class="text-sm font-mono" id="current-time">--:-- IST</span>
                <span class="text-xs" id="current-date">-- --- ----</span>
            </div>
        </div>
    </div> -->
</nav>

                <!-- Mobile Menu Button -->
                <!-- <button class="md:hidden p-2 rounded-md text-text-secondary hover:text-text-primary hover:bg-slate-100">
                    <i class="fas fa-bars text-lg"></i>
                </button> -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden">
        <div class="h-screen flex flex-col lg:flex-row">
            <!-- Map Container -->
            <div class="flex-1 relative">
                <div id="map" class="w-full h-full"></div>
                
<!-- Map Controls Overlay -->
<div class="absolute top-4 right-4 z-[1000] flex flex-col space-y-2">
    <button id="reset-view" class="aviation-button-secondary p-2 rounded-lg shadow-aviation-md" title="Reset Map View">
        <i class="fas fa-home"></i>
    </button>
    <button id="clear-route" class="aviation-button-secondary p-2 rounded-lg shadow-aviation-md" title="Clear Route">
        <i class="fas fa-trash"></i>
    </button>
    <button id="toggle-tracking" class="aviation-button-secondary p-2 rounded-lg shadow-aviation-md" title="Toggle Position Tracking">
        <i class="fas fa-location-arrow"></i>
    </button>
    <button id="satellite-toggle" class="aviation-button-secondary p-2 rounded-lg shadow-aviation-md" title="Toggle Satellite View">
        <i class="fas fa-satellite"></i>
    </button>
    
    <!-- Map Orientation Controls -->
    <div class="bg-white rounded-lg shadow-aviation-md p-2 border border-slate-200">
        <div class="text-xs text-text-secondary mb-2 text-center font-semibold">Map Orientation</div>
        <div class="grid grid-cols-2 gap-1">
            <button id="north-up" class="orientation-btn active p-1.5 text-xs rounded flex flex-col items-center space-y-1" title="North Up">
                <i class="fas fa-compass text-primary"></i>
                <span>N</span>
            </button>
            <button id="south-up" class="orientation-btn p-1.5 text-xs rounded flex flex-col items-center space-y-1" title="South Up">
                <i class="fas fa-compass text-text-secondary" style="transform: rotate(180deg);"></i>
                <span>S</span>
            </button>
            <button id="east-up" class="orientation-btn p-1.5 text-xs rounded flex flex-col items-center space-y-1" title="East Up">
                <i class="fas fa-compass text-text-secondary" style="transform: rotate(90deg);"></i>
                <span>E</span>
            </button>
            <button id="west-up" class="orientation-btn p-1.5 text-xs rounded flex flex-col items-center space-y-1" title="West Up">
                <i class="fas fa-compass text-text-secondary" style="transform: rotate(270deg);"></i>
                <span>W</span>
            </button>
        </div>
        <div class="mt-2 pt-2 border-t border-slate-100">
            <div class="text-xs text-text-secondary text-center">
                <span id="current-orientation">North Up</span>
            </div>
        </div>
    </div>
</div>

                <!-- Real-time Position Status -->
                <div id="position-status" class="absolute top-4 left-4 z-[1000] position-status p-3 max-w-sm hidden">
                    <h4 class="font-semibold text-sm text-text-primary mb-2 flex items-center space-x-2">
                        <i class="fas fa-satellite-dish text-primary"></i>
                        <span>Live Position Tracking</span>
                        <div id="tracking-indicator" class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
                    </h4>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between items-center">
                            <span class="text-text-secondary">Current Position:</span>
                            <span id="current-coords" class="text-text-primary font-mono">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-text-secondary">Direction:</span>
                            <span id="current-direction" class="text-text-primary font-mono">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-text-secondary">Speed:</span>
                            <span id="current-speed" class="text-text-primary font-mono">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-text-secondary">Altitude:</span>
                            <span id="current-altitude" class="text-text-primary font-mono">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-text-secondary">Accuracy:</span>
                            <span id="position-accuracy" class="text-text-primary font-mono">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-text-secondary">Local Time:</span>
                            <span id="local-time" class="text-text-primary font-mono">-</span>
                        </div>
                        <div class="pt-2 border-t border-slate-200">
                            <div class="text-text-secondary">
                                <i class="fas fa-info-circle mr-1"></i>
                                <span>Updates every 3 seconds</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Map Legend -->
                <div class="absolute bottom-4 left-4 z-[1000] aviation-card p-3 max-w-xs">
                    <h4 class="font-semibold text-sm text-text-primary mb-2">Map Legend</h4>
                    <div class="space-y-1 text-xs">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-success rounded-full"></div>
                            <span class="text-text-secondary">Departure Airport</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-error rounded-full"></div>
                            <span class="text-text-secondary">Arrival Airport</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-0.5 bg-primary"></div>
                            <span class="text-text-secondary">Flight Route</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="direction-arrow" style="width: 12px !important; height: 12px !important; animation: none;"></div>
                            <span class="text-text-secondary">Current Position</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-satellite text-accent text-xs"></i>
                            <span class="text-text-secondary">Satellite View Available</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="w-full lg:w-96 bg-white border-t lg:border-t-0 lg:border-l border-slate-200 flex flex-col">
                <!-- Panel Header -->
                <div class="p-6 border-b border-slate-200">
                    <h2 class="text-lg font-semibold text-text-primary flex items-center space-x-2">
                        <i class="fas fa-route text-primary"></i>
                        <span>Flight Route Planning</span>
                    </h2>
                    <p class="text-sm text-text-secondary mt-1">Plan your flight route with precision timing (IST)</p>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    <!-- Direction System Controls -->
                    <div class="space-y-4">
                        <h3 class="font-medium text-text-primary flex items-center space-x-2">
                            <i class="fas fa-navigation text-accent text-sm"></i>
                            <span>Direction System</span>
                        </h3>
                        
                        <div class="aviation-card p-4">
                            <div class="grid grid-cols-1 gap-3">
                                <button id="start-navigation" class="aviation-button-primary py-2 text-xs flex items-center justify-center space-x-2 disabled:opacity-50">
                                    <i class="fas fa-play"></i>
                                    <span>Start Live Navigation</span>
                                </button>
                                <button id="stop-navigation" class="aviation-button-secondary py-2 text-xs flex items-center justify-center space-x-2 hidden">
                                    <i class="fas fa-stop"></i>
                                    <span>Stop Navigation</span>
                                </button>
                                <button id="center-position" class="aviation-button-secondary py-2 text-xs flex items-center justify-center space-x-2 disabled:opacity-50" disabled>
                                    <i class="fas fa-crosshairs"></i>
                                    <span>Center on Position</span>
                                </button>
                            </div>
                            
                            <div class="mt-3 pt-3 border-t border-slate-200">
                                <div class="text-xs text-text-secondary space-y-1">
                                    <p><i class="fas fa-shield-alt mr-1"></i>Requires location permissions</p>
                                    <p><i class="fas fa-battery-three-quarters mr-1"></i>Uses GPS for real-time tracking</p>
                                    <p><i class="fas fa-tachometer-alt mr-1"></i>Updates position every 3 seconds</p>
                                    <p><i class="fas fa-clock mr-1"></i>All timing calculations in IST</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Coordinate Entry -->
                    <div class="space-y-4">
                        <h3 class="font-medium text-text-primary flex items-center space-x-2">
                            <i class="fas fa-crosshairs text-accent text-sm"></i>
                            <span>Coordinate Entry</span>
                        </h3>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <!-- Departure Coordinates -->
                            <div class="aviation-card p-4">
                                <h4 class="text-sm font-medium text-text-primary mb-3 flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-success rounded-full"></div>
                                    <span>Departure Coordinates</span>
                                </h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-text-secondary mb-1">Latitude</label>
                                        <input type="number" id="dep-lat" class="aviation-input text-xs" placeholder="28.5562" step="any" min="-90" max="90" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-text-secondary mb-1">Longitude</label>
                                        <input type="number" id="dep-lng" class="aviation-input text-xs" placeholder="77.1000" step="any" min="-180" max="180" />
                                    </div>
                                </div>
                            </div>

                            <!-- Arrival Coordinates -->
                            <div class="aviation-card p-4">
                                <h4 class="text-sm font-medium text-text-primary mb-3 flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-error rounded-full"></div>
                                    <span>Arrival Coordinates</span>
                                </h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-text-secondary mb-1">Latitude</label>
                                        <input type="number" id="arr-lat" class="aviation-input text-xs" placeholder="19.0896" step="any" min="-90" max="90" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-text-secondary mb-1">Longitude</label>
                                        <input type="number" id="arr-lng" class="aviation-input text-xs" placeholder="72.8656" step="any" min="-180" max="180" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <button id="plot-route" class="aviation-button-primary w-full py-3 text-sm font-semibold flex items-center justify-center space-x-2">
                            <i class="fas fa-route"></i>
                            <span>Calculate Precise Route</span>
                        </button>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button id="validate-coords" class="aviation-button-secondary py-2 text-xs flex items-center justify-center space-x-1">
                                <i class="fas fa-check-circle"></i>
                                <span>Validate</span>
                            </button>
                            <button id="swap-airports" class="aviation-button-secondary py-2 text-xs flex items-center justify-center space-x-1">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Swap</span>
                            </button>
                        </div>
                    </div>

                    <!-- Enhanced Flight Metrics Display -->
                    <div id="flight-metrics" class="space-y-4 hidden">
                        <h3 class="font-medium text-text-primary flex items-center space-x-2">
                            <i class="fas fa-calculator text-accent text-sm"></i>
                            <span>Precision Flight Analytics</span>
                        </h3>
                        
                        <div class="aviation-card p-4 space-y-4">
                            <!-- Route Information -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Route</span>
                                    <span id="route-info" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Distance (NM)</span>
                                    <span id="distance-nm" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Distance (KM)</span>
                                    <span id="distance-km" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Flight Time</span>
                                    <span id="flight-time" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Departure Time (IST)</span>
                                    <span id="departure-time" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Arrival Time (IST)</span>
                                    <span id="arrival-time" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Bearing</span>
                                    <span id="bearing" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Ground Speed</span>
                                    <span id="ground-speed" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Cruise Altitude</span>
                                    <span id="cruise-altitude" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">Fuel Estimate</span>
                                    <span id="fuel-estimate" class="text-sm font-mono text-text-primary">-</span>
                                </div>
                            </div>
                            
                            <!-- Additional Info -->
                            <div class="pt-3 border-t border-slate-200">
                                <div class="text-xs text-text-secondary space-y-1">
                                    <p><i class="fas fa-info-circle mr-1"></i>Calculations with wind compensation</p>
                                    <p><i class="fas fa-tachometer-alt mr-1"></i>Commercial jet performance data</p>
                                    <p><i class="fas fa-clock mr-1"></i>Indian Standard Time (UTC+5:30)</p>
                                    <p><i class="fas fa-route mr-1"></i>Great-circle navigation route</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div id="error-display" class="hidden">
                        <div class="bg-error-50 border border-error-200 rounded-lg p-4">
                            <div class="flex items-start space-x-2">
                                <i class="fas fa-exclamation-triangle text-error mt-0.5"></i>
                                <div>
                                    <h4 class="text-sm font-medium text-error">Input Error</h4>
                                    <p id="error-message" class="text-xs text-error-700 mt-1"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel Footer -->
                <div class="p-6 border-t border-slate-200 bg-slate-50">
                    <div class="text-xs text-text-secondary space-y-1">
                        <p class="flex items-center space-x-1">
                            <i class="fas fa-shield-alt"></i>
                            <span>Aviation industry standard compliance</span>
                        </p>
                        <p class="flex items-center space-x-1">
                            <i class="fas fa-satellite"></i>
                            <span>High-resolution satellite imagery</span>
                        </p>
                        <p class="text-center mt-2">© 2025 AirRoute Navigator. All Rights Reserved.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] flex items-center justify-center hidden">
        <div class="aviation-card p-6 max-w-sm mx-4">
            <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
                <p class="text-sm text-text-primary">Calculating precision route...</p>
            </div>
        </div>
    </div>

    <script>
    // Global variables
    let map;
    let departureMarker = null;
    let arrivalMarker = null;
    let routeLine = null;
    let currentPositionMarker = null;
    let isNavigationActive = false;
    let watchId = null;
    let lastKnownPosition = null;
    let lastDirection = 0;
    let satelliteLayer = null;
    let openStreetMapLayer = null;
    let isSatelliteView = false;
    let currentOrientation = 0; // 0=North, 90=East, 180=South, 270=West
    let placeNamesLayer = null;
    
    // Initialize map with enhanced satellite view capability and place names
    function initMap() {
        // Center on India for IST timezone relevance
        map = L.map('map', {
            center: [20.5937, 78.9629],
            zoom: 5,
            zoomControl: false // We'll add custom controls
        });
        
        // Add zoom control to bottom right
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);
        
        // Create base layers
        openStreetMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        });

        // Enhanced satellite view using Esri World Imagery (high quality)
        satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri, Maxar, Earthstar Geographics, © OpenStreetMap contributors',
            maxZoom: 19
        });
        
        // Add satellite view as default
        satelliteLayer.addTo(map);
        isSatelliteView = true;
        
        // Add place names overlay for satellite view
        addPlaceNamesOverlay();
        
        // Add map event listeners
        map.on('click', function(e) {
            console.log('Map clicked at:', e.latlng);
            // Add reverse geocoding for clicked location
            reverseGeocode(e.latlng.lat, e.latlng.lng);
        });
        
        map.on('zoomend', function() {
            updatePlaceNamesVisibility();
        });
        
        // Check geolocation support
        if ("geolocation" in navigator) {
            console.log("Geolocation is supported");
        } else {
            console.log("Geolocation is not supported");
            showError("Geolocation is not supported by this browser.");
        }
    }
    
    // Add place names overlay for satellite view
    function addPlaceNamesOverlay() {
        // OpenStreetMap labels overlay for place names on satellite view
        placeNamesLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '',
            opacity: 0,
            maxZoom: 18,
            className: 'place-names-layer'
        });

        // Create a custom layer for place names using Stamen labels
        placeNamesLayer = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png', {
            attribution: 'Map labels by Stamen Design',
            opacity: 0.8,
            maxZoom: 18
        });
        
        if (isSatelliteView) {
            placeNamesLayer.addTo(map);
        }
    }
    
    // Update place names visibility based on zoom level
    function updatePlaceNamesVisibility() {
        if (placeNamesLayer && isSatelliteView) {
            const zoom = map.getZoom();
            if (zoom > 6) {
                placeNamesLayer.setOpacity(0.9);
            } else if (zoom > 4) {
                placeNamesLayer.setOpacity(0.7);
            } else {
                placeNamesLayer.setOpacity(0.5);
            }
        }
    }
    
    // Reverse geocoding for location names
    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`);
            const data = await response.json();
            
            if (data && data.display_name) {
                const locationName = data.display_name.split(',').slice(0, 3).join(', ');
                
                // Create popup with place information
                const popup = L.popup()
                    .setLatLng([lat, lng])
                    .setContent(`
                        <div class="place-name-popup">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${locationName}</span>
                        </div>
                        <div style="font-size: 10px; color: #64748b; margin-top: 4px;">
                            ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        </div>
                    `)
                    .openOn(map);
            }
        } catch (error) {
            console.error('Reverse geocoding failed:', error);
        }
    }
    
    // Toggle between satellite and map view with place names
    function toggleSatelliteView() {
        if (isSatelliteView) {
            // Switch to OpenStreetMap
            map.removeLayer(satelliteLayer);
            if (placeNamesLayer) {
                map.removeLayer(placeNamesLayer);
            }
            openStreetMapLayer.addTo(map);
            isSatelliteView = false;
            showError("Switched to OpenStreetMap view", true);
        } else {
            // Switch to satellite
            map.removeLayer(openStreetMapLayer);
            satelliteLayer.addTo(map);
            addPlaceNamesOverlay();
            isSatelliteView = true;
            showError("Switched to Satellite view with place names", true);
        }
        
        // Update button appearance
        const toggleBtn = document.getElementById('satellite-toggle');
        if (toggleBtn) {
            if (isSatelliteView) {
                toggleBtn.classList.add('tracking-active');
            } else {
                toggleBtn.classList.remove('tracking-active');
            }
        }
    }
    
    // Map orientation controls
    function setMapOrientation(orientation) {
        currentOrientation = orientation;
        
        // Apply CSS transform to rotate the map
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.style.transform = `rotate(${orientation}deg)`;
            mapContainer.style.transition = 'transform 0.5s ease';
        }
        
        // Update active button
        document.querySelectorAll('.orientation-btn').forEach(btn => {
            btn.classList.remove('active');
            const icon = btn.querySelector('i');
            icon.style.color = '#64748B';
        });
        
        let activeBtn, orientationText;
        switch(orientation) {
            case 0:
                activeBtn = document.getElementById('north-up');
                orientationText = 'North Up';
                break;
            case 90:
                activeBtn = document.getElementById('east-up');
                orientationText = 'East Up';
                break;
            case 180:
                activeBtn = document.getElementById('south-up');
                orientationText = 'South Up';
                break;
            case 270:
                activeBtn = document.getElementById('west-up');
                orientationText = 'West Up';
                break;
        }
        
        if (activeBtn) {
            activeBtn.classList.add('active');
            const icon = activeBtn.querySelector('i');
            icon.style.color = 'white';
        }
        
        // Update orientation text
        const orientationDisplay = document.getElementById('current-orientation');
        if (orientationDisplay) {
            orientationDisplay.textContent = orientationText;
        }
        
        showError(`Map orientation set to ${orientationText}`, true);
    }
    
    // Create animated direction arrow marker
    function createDirectionArrow(rotation = 0) {
        const totalRotation = rotation + currentOrientation;
        const arrowIcon = L.divIcon({
            className: 'direction-arrow-container',
            html: `<div class="direction-arrow" style="transform: rotate(${totalRotation}deg);"></div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        return arrowIcon;
    }
    
    // Enhanced real-time date and time update
    function updateDateTime() {
        const now = new Date();
        const ist = convertToIST(now);
        
        // Update time
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.textContent = ist.toLocaleTimeString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }) + ' IST';
        }
        
        // Update date
        const dateElement = document.getElementById('current-date');
        if (dateElement) {
            dateElement.textContent = ist.toLocaleDateString('en-IN', {
                timeZone: 'Asia/Kolkata',
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
    }
    
    // Convert UTC to IST
    function convertToIST(utcDate) {
        const utc = new Date(utcDate);
        const ist = new Date(utc.getTime() + (5.5 * 60 * 60 * 1000)); // Add 5 hours 30 minutes
        return ist;
    }
    
    // Format time to IST string
    function formatIST(date) {
        return date.toLocaleTimeString('en-IN', {
            timeZone: 'Asia/Kolkata',
            hour12: false,
            hour: '2-digit',
            minute: '2-digit'
        }) + ' IST';
    }
    
    // Enhanced position status update with IST timing
    function updatePositionStatus(position) {
        const coords = position.coords;
        const currentTime = new Date(position.timestamp);
        const istTime = convertToIST(currentTime);
        
        // Update display elements
        const currentCoordsEl = document.getElementById('current-coords');
        const currentDirectionEl = document.getElementById('current-direction');
        const currentSpeedEl = document.getElementById('current-speed');
        const currentAltitudeEl = document.getElementById('current-altitude');
        const positionAccuracyEl = document.getElementById('position-accuracy');
        const localTimeEl = document.getElementById('local-time');
        
        if (currentCoordsEl) {
            currentCoordsEl.textContent = `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
        }
        
        if (currentDirectionEl) {
            const direction = coords.heading !== null ? `${coords.heading.toFixed(1)}°` : 'N/A';
            currentDirectionEl.textContent = direction;
        }
        
        if (currentSpeedEl) {
            const speed = coords.speed !== null ? `${(coords.speed * 3.6).toFixed(1)} km/h` : 'N/A';
            currentSpeedEl.textContent = speed;
        }
        
        if (currentAltitudeEl) {
            const altitude = coords.altitude !== null ? `${coords.altitude.toFixed(0)} m` : 'N/A';
            currentAltitudeEl.textContent = altitude;
        }
        
        if (positionAccuracyEl) {
            positionAccuracyEl.textContent = `±${coords.accuracy.toFixed(0)} m`;
        }
        
        if (localTimeEl) {
            localTimeEl.textContent = formatIST(istTime);
        }
    }
    
    // Calculate direction between two points
    function calculateDirection(lat1, lon1, lat2, lon2) {
        const dLon = toRadians(lon2 - lon1);
        const y = Math.sin(dLon) * Math.cos(toRadians(lat2));
        const x = Math.cos(toRadians(lat1)) * Math.sin(toRadians(lat2)) -
                Math.sin(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.cos(dLon);
        let bearing = toDegrees(Math.atan2(y, x));
        return (bearing + 360) % 360;
    }
    
    // Start enhanced real-time navigation
    function startNavigation() {
        if (!navigator.geolocation) {
            showError("Geolocation is not supported by this browser.");
            return;
        }
        
        const options = {
            enableHighAccuracy: true,
            timeout: 8000,
            maximumAge: 3000 // Reduced for more frequent updates
        };
        
        isNavigationActive = true;
        
        // Show position status panel
        const positionStatus = document.getElementById('position-status');
        if (positionStatus) {
            positionStatus.classList.remove('hidden');
        }
        
        // Update button states
        const startBtn = document.getElementById('start-navigation');
        const stopBtn = document.getElementById('stop-navigation');
        const centerBtn = document.getElementById('center-position');
        const toggleBtn = document.getElementById('toggle-tracking');
        
        if (startBtn) {
            startBtn.classList.add('hidden');
        }
        if (stopBtn) {
            stopBtn.classList.remove('hidden');
        }
        if (centerBtn) {
            centerBtn.disabled = false;
            centerBtn.classList.remove('disabled:opacity-50');
        }
        if (toggleBtn) {
            toggleBtn.classList.add('tracking-active');
        }
        
        // Start watching position with increased frequency
        watchId = navigator.geolocation.watchPosition(
            function(position) {
                const coords = position.coords;
                const lat = coords.latitude;
                const lng = coords.longitude;
                
                // Calculate direction if we have a previous position
                let direction = lastDirection;
                if (lastKnownPosition) {
                    direction = calculateDirection(
                        lastKnownPosition.lat,
                        lastKnownPosition.lng,
                        lat,
                        lng
                    );
                    lastDirection = direction;
                }
                
                // Update or create current position marker with orientation-aware arrow
                if (currentPositionMarker) {
                    // Update existing marker position and rotation
                    currentPositionMarker.setLatLng([lat, lng]);
                    currentPositionMarker.setIcon(createDirectionArrow(direction));
                } else {
                    // Create new marker
                    currentPositionMarker = L.marker([lat, lng], {
                        icon: createDirectionArrow(direction),
                        zIndexOffset: 1000
                    }).addTo(map);
                    
                    // Add tooltip
                    currentPositionMarker.bindTooltip("Current Position", {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -20]
                    });
                }
                
                // Update position status with IST time
                updatePositionStatus(position);
                
                // Store current position
                lastKnownPosition = { lat, lng };
                
                // Try to get location name
                reverseGeocode(lat, lng);
                
                showError("Position updated successfully!", true);
            },
            function(error) {
                let errorMsg = "Location error: ";
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg += "Location access denied by user.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg += "Location information unavailable.";
                        break;
                    case error.TIMEOUT:
                        errorMsg += "Location request timed out.";
                        break;
                    default:
                        errorMsg += "Unknown location error.";
                        break;
                }
                showError(errorMsg);
                console.error("Geolocation error:", error);
            },
            options
        );
    }
    
    // Stop real-time navigation
    function stopNavigation() {
        isNavigationActive = false;
        
        // Stop watching position
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        
        // Hide position status panel
        const positionStatus = document.getElementById('position-status');
        if (positionStatus) {
            positionStatus.classList.add('hidden');
        }
        
        // Remove current position marker
        if (currentPositionMarker) {
            map.removeLayer(currentPositionMarker);
            currentPositionMarker = null;
        }
        
        // Update button states
        const startBtn = document.getElementById('start-navigation');
        const stopBtn = document.getElementById('stop-navigation');
        const centerBtn = document.getElementById('center-position');
        const toggleBtn = document.getElementById('toggle-tracking');
        
        if (startBtn) {
            startBtn.classList.remove('hidden');
        }
        if (stopBtn) {
            stopBtn.classList.add('hidden');
        }
        if (centerBtn) {
            centerBtn.disabled = true;
            centerBtn.classList.add('disabled:opacity-50');
        }
        if (toggleBtn) {
            toggleBtn.classList.remove('tracking-active');
        }
        
        // Reset position data
        lastKnownPosition = null;
        lastDirection = 0;
        
        showError("Navigation stopped.", true);
    }
    
    // Center map on current position
    function centerOnPosition() {
        if (lastKnownPosition) {
            map.setView([lastKnownPosition.lat, lastKnownPosition.lng], 15);
            showError("Centered on current position.", true);
        } else {
            showError("No current position available.");
        }
    }
    
    // Enhanced Haversine formula with more precision
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371.0088; // More precise Earth's radius in kilometers
        const dLat = toRadians(lat2 - lat1);
        const dLon = toRadians(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    function toRadians(degrees) {
        return degrees * (Math.PI/180);
    }
    
    function toDegrees(radians) {
        return radians * (180/Math.PI);
    }
    
    // Calculate bearing
    function calculateBearing(lat1, lon1, lat2, lon2) {
        const dLon = toRadians(lon2 - lon1);
        const y = Math.sin(dLon) * Math.cos(toRadians(lat2));
        const x = Math.cos(toRadians(lat1)) * Math.sin(toRadians(lat2)) -
                Math.sin(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.cos(dLon);
        let bearing = toDegrees(Math.atan2(y, x));
        return (bearing + 360) % 360;
    }
    
    // Enhanced altitude calculation based on distance
    function calculateCruiseAltitude(distanceKm) {
        if (distanceKm < 500) return 25000; // Short haul: 25,000 ft
        if (distanceKm < 1500) return 35000; // Medium haul: 35,000 ft
        return 41000; // Long haul: 41,000 ft
    }
    
    // Enhanced ground speed calculation with wind compensation
    function calculateGroundSpeed(distanceKm) {
        const baseSpeed = 850; // Base speed in km/h
        const windFactor = 0.95; // Assume 5% headwind on average
        return Math.round(baseSpeed * windFactor);
    }
    
    // Fuel consumption estimate
    function calculateFuelEstimate(distanceKm, flightTimeHours) {
        const fuelPerHour = 2500; // Average fuel consumption in kg/hour for commercial jet
        const totalFuel = fuelPerHour * flightTimeHours;
        const fuelMargin = totalFuel * 0.15; // 15% safety margin
        return Math.round(totalFuel + fuelMargin);
    }
    
    // Validate coordinates
    function validateCoordinates(lat, lng) {
        if (isNaN(lat) || isNaN(lng)) return false;
        if (lat < -90 || lat > 90) return false;
        if (lng < -180 || lng > 180) return false;
        return true;
    }
    
    // Show error message - Enhanced with proper error handling
    function showError(message, isSuccess = false) {
        // Early return if DOM is not ready
        if (document.readyState === 'loading') {
            console.log('DOM not ready, deferring error display:', message);
            return;
        }
        
        const errorDisplay = document.getElementById('error-display');
        
        // Enhanced error handling with fallback
        if (!errorDisplay) {
            console.warn('Error display element not found, falling back to console:', message);
            if (isSuccess) {
                console.log('✓ Success:', message);
            } else {
                console.error('✗ Error:', message);
            }
            return;
        }
        
        // Create dynamic error content
        const errorClass = isSuccess ? 'bg-success-50 border-success-200' : 'bg-error-50 border-error-200';
        const iconClass = isSuccess ? 'fa-check-circle text-success' : 'fa-exclamation-triangle text-error';
        const titleClass = isSuccess ? 'text-success' : 'text-error';
        const messageClass = isSuccess ? 'text-success-700' : 'text-error-700';
        const title = isSuccess ? 'Success' : 'Error';
        
        errorDisplay.innerHTML = `
            <div class="${errorClass} rounded-lg p-4">
                <div class="flex items-start space-x-2">
                    <i class="fas ${iconClass} mt-0.5"></i>
                    <div>
                        <h4 class="text-sm font-medium ${titleClass}">${title}</h4>
                        <p class="text-xs ${messageClass} mt-1">${message}</p>
                    </div>
                </div>
            </div>
        `;
        
        errorDisplay.classList.remove('hidden');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (errorDisplay) {
                errorDisplay.classList.add('hidden');
            }
        }, 5000);
    }
    
    // Clear route
    function clearRoute() {
        if (departureMarker) {
            map.removeLayer(departureMarker);
            departureMarker = null;
        }
        if (arrivalMarker) {
            map.removeLayer(arrivalMarker);
            arrivalMarker = null;
        }
        if (routeLine) {
            map.removeLayer(routeLine);
            routeLine = null;
        }
        const flightMetrics = document.getElementById('flight-metrics');
        if (flightMetrics) {
            flightMetrics.classList.add('hidden');
        }
        
        showError("Route cleared successfully.", true);
    }
    
    // Enhanced plot route with precision timing
    function plotRoute() {
        // Get coordinates from manual inputs
        let depLat, depLng, arrLat, arrLng;
        
        const depLatInput = document.getElementById('dep-lat');
        const depLngInput = document.getElementById('dep-lng');
        const arrLatInput = document.getElementById('arr-lat');
        const arrLngInput = document.getElementById('arr-lng');
        
        if (depLatInput && depLngInput && arrLatInput && arrLngInput) {
            depLat = parseFloat(depLatInput.value);
            depLng = parseFloat(depLngInput.value);
            arrLat = parseFloat(arrLatInput.value);
            arrLng = parseFloat(arrLngInput.value);
        }
        
        // Validate coordinates
        if (!validateCoordinates(depLat, depLng)) {
            showError('Invalid departure coordinates. Latitude must be between -90 and 90, longitude between -180 and 180.');
            return;
        }
        
        if (!validateCoordinates(arrLat, arrLng)) {
            showError('Invalid arrival coordinates. Latitude must be between -90 and 90, longitude between -180 and 180.');
            return;
        }
        
        // Show loading
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.classList.remove('hidden');
        }
        
        setTimeout(() => {
            try {
                // Clear existing route
                clearRoute();
                
                // Add departure marker with enhanced popup
                departureMarker = L.marker([depLat, depLng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div class="w-5 h-5 bg-success rounded-full border-3 border-white shadow-lg flex items-center justify-center"><i class="fas fa-plane-departure text-white text-xs"></i></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                // Add reverse geocoding for departure
                reverseGeocode(depLat, depLng);
                
                // Add arrival marker with enhanced popup
                arrivalMarker = L.marker([arrLat, arrLng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div class="w-5 h-5 bg-error rounded-full border-3 border-white shadow-lg flex items-center justify-center"><i class="fas fa-plane-arrival text-white text-xs"></i></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                // Add reverse geocoding for arrival
                reverseGeocode(arrLat, arrLng);
                
                // Add enhanced route line
                routeLine = L.polyline([[depLat, depLng], [arrLat, arrLng]], {
                    color: '#1E40AF',
                    weight: 4,
                    opacity: 0.9,
                    dashArray: '12, 8'
                }).addTo(map);
                
                // Fit map to show both points with padding
                const group = new L.featureGroup([departureMarker, arrivalMarker]);
                map.fitBounds(group.getBounds().pad(0.15));
                
                // Enhanced calculations
                const distanceKm = calculateDistance(depLat, depLng, arrLat, arrLng);
                const distanceNm = distanceKm * 0.539957;
                const groundSpeed = calculateGroundSpeed(distanceKm);
                const flightTimeHours = distanceKm / groundSpeed;
                const bearing = calculateBearing(depLat, depLng, arrLat, arrLng);
                const cruiseAltitude = calculateCruiseAltitude(distanceKm);
                const fuelEstimate = calculateFuelEstimate(distanceKm, flightTimeHours);
                
                // Calculate departure and arrival times in IST
                const now = new Date();
                const currentIST = convertToIST(now);
                const departureTime = new Date(currentIST.getTime() + (30 * 60 * 1000)); // Departure in 30 minutes
                const arrivalTime = new Date(departureTime.getTime() + (flightTimeHours * 60 * 60 * 1000));
                
                // Update enhanced metrics display
                const routeInfo = document.getElementById('route-info');
                const distanceNmEl = document.getElementById('distance-nm');
                const distanceKmEl = document.getElementById('distance-km');
                const flightTimeEl = document.getElementById('flight-time');
                const departureTimeEl = document.getElementById('departure-time');
                const arrivalTimeEl = document.getElementById('arrival-time');
                const bearingEl = document.getElementById('bearing');
                const groundSpeedEl = document.getElementById('ground-speed');
                const cruiseAltitudeEl = document.getElementById('cruise-altitude');
                const fuelEstimateEl = document.getElementById('fuel-estimate');
                
                if (routeInfo) {
                    routeInfo.textContent = `${depLat.toFixed(4)},${depLng.toFixed(4)} → ${arrLat.toFixed(4)},${arrLng.toFixed(4)}`;
                }
                if (distanceNmEl) {
                    distanceNmEl.textContent = `${distanceNm.toFixed(2)} NM`;
                }
                if (distanceKmEl) {
                    distanceKmEl.textContent = `${distanceKm.toFixed(2)} KM`;
                }
                if (flightTimeEl) {
                    const hours = Math.floor(flightTimeHours);
                    const minutes = Math.round((flightTimeHours % 1) * 60);
                    flightTimeEl.textContent = `${hours}h ${minutes}m`;
                }
                if (departureTimeEl) {
                    departureTimeEl.textContent = formatIST(departureTime);
                }
                if (arrivalTimeEl) {
                    arrivalTimeEl.textContent = formatIST(arrivalTime);
                }
                if (bearingEl) {
                    bearingEl.textContent = `${bearing.toFixed(1)}°`;
                }
                if (groundSpeedEl) {
                    groundSpeedEl.textContent = `${groundSpeed} km/h`;
                }
                if (cruiseAltitudeEl) {
                    cruiseAltitudeEl.textContent = `${cruiseAltitude.toLocaleString()} ft`;
                }
                if (fuelEstimateEl) {
                    fuelEstimateEl.textContent = `${fuelEstimate.toLocaleString()} kg`;
                }
                
                // Show enhanced metrics
                const flightMetrics = document.getElementById('flight-metrics');
                if (flightMetrics) {
                    flightMetrics.classList.remove('hidden');
                }
                
                showError("Precision flight route calculated successfully!", true);
            } catch (error) {
                console.error('Error plotting route:', error);
                showError('Failed to calculate route. Please try again.');
            } finally {
                // Hide loading
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
            }
        }, 1500); // Slightly longer for enhanced calculations
    }
    
    // Swap airports
    function swapAirports() {
        const depLat = document.getElementById('dep-lat');
        const depLng = document.getElementById('dep-lng');
        const arrLat = document.getElementById('arr-lat');
        const arrLng = document.getElementById('arr-lng');
        
        if (depLat && depLng && arrLat && arrLng) {
            // Swap manual coordinates
            const tempLat = depLat.value;
            const tempLng = depLng.value;
            depLat.value = arrLat.value;
            depLng.value = arrLng.value;
            arrLat.value = tempLat;
            arrLng.value = tempLng;
        }
        
        showError("Coordinates swapped successfully!", true);
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        try {
            initMap();
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update every second for real-time display
            
            // Map orientation control handlers
            const northUpBtn = document.getElementById('north-up');
            if (northUpBtn) {
                northUpBtn.addEventListener('click', () => setMapOrientation(0));
            }
            
            const eastUpBtn = document.getElementById('east-up');
            if (eastUpBtn) {
                eastUpBtn.addEventListener('click', () => setMapOrientation(90));
            }
            
            const southUpBtn = document.getElementById('south-up');
            if (southUpBtn) {
                southUpBtn.addEventListener('click', () => setMapOrientation(180));
            }
            
            const westUpBtn = document.getElementById('west-up');
            if (westUpBtn) {
                westUpBtn.addEventListener('click', () => setMapOrientation(270));
            }
            
            // Satellite toggle handler
            const satelliteToggleBtn = document.getElementById('satellite-toggle');
            if (satelliteToggleBtn) {
                satelliteToggleBtn.addEventListener('click', toggleSatelliteView);
            }
            
            // Navigation control handlers
            const startNavBtn = document.getElementById('start-navigation');
            if (startNavBtn) {
                startNavBtn.addEventListener('click', startNavigation);
            }
            
            const stopNavBtn = document.getElementById('stop-navigation');
            if (stopNavBtn) {
                stopNavBtn.addEventListener('click', stopNavigation);
            }
            
            const centerBtn = document.getElementById('center-position');
            if (centerBtn) {
                centerBtn.addEventListener('click', centerOnPosition);
            }
            
            const toggleTrackingBtn = document.getElementById('toggle-tracking');
            if (toggleTrackingBtn) {
                toggleTrackingBtn.addEventListener('click', function() {
                    if (isNavigationActive) {
                        stopNavigation();
                    } else {
                        startNavigation();
                    }
                });
            }
            
            // Button handlers
            const plotRouteBtn = document.getElementById('plot-route');
            if (plotRouteBtn) {
                plotRouteBtn.addEventListener('click', plotRoute);
            }
            
            const clearRouteBtn = document.getElementById('clear-route');
            if (clearRouteBtn) {
                clearRouteBtn.addEventListener('click', clearRoute);
            }
            
            const resetViewBtn = document.getElementById('reset-view');
            if (resetViewBtn) {
                resetViewBtn.addEventListener('click', function() {
                    map.setView([20.5937, 78.9629], 5);
                    setMapOrientation(0); // Reset to North Up
                    showError("Map view and orientation reset to default.", true);
                });
            }
            
            const swapBtn = document.getElementById('swap-airports');
            if (swapBtn) {
                swapBtn.addEventListener('click', swapAirports);
            }
            
            const validateBtn = document.getElementById('validate-coords');
            if (validateBtn) {
                validateBtn.addEventListener('click', function() {
                    const depLatInput = document.getElementById('dep-lat');
                    const depLngInput = document.getElementById('dep-lng');
                    const arrLatInput = document.getElementById('arr-lat');
                    const arrLngInput = document.getElementById('arr-lng');
                    
                    if (!depLatInput || !depLngInput || !arrLatInput || !arrLngInput) {
                        showError('Coordinate input fields not found.');
                        return;
                    }
                    
                    const depLat = parseFloat(depLatInput.value);
                    const depLng = parseFloat(depLngInput.value);
                    const arrLat = parseFloat(arrLatInput.value);
                    const arrLng = parseFloat(arrLngInput.value);
                    
                    if (validateCoordinates(depLat, depLng) && validateCoordinates(arrLat, arrLng)) {
                        showError('All coordinates are valid!', true);
                    } else {
                        showError('Please check your coordinate inputs. Some values may be invalid.');
                    }
                });
            }
            
            console.log('Enhanced flight route planner with real-time IST, place names, and map orientation controls initialized successfully');
        } catch (error) {
            console.error('Error initializing enhanced flight route planner:', error);
        }
    });
</script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>